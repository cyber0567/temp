// Prisma schema for Supabase (PostgreSQL). Manages only "public" schema.
// Use Session mode pooler (port 6543). Set DATABASE_URL and DIRECT_URL in .env.
// One-time: drop public.auth_events in Supabase SQL Editor so Prisma does not reference auth schema.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum OrgRole {
  admin
  member
  viewer
}

enum PlatformRole {
  rep
  admin
  super_admin
}

model User {
  id             String    @id @default(uuid()) @db.Uuid
  email          String    @unique
  passwordHash   String    @map("password_hash")
  supabaseUserId String?   @unique @map("supabase_user_id") @db.Uuid
  createdAt      DateTime  @default(now()) @map("created_at")
  @@map("users")
}

model Profile {
  id           String        @id // text: custom id (e.g. uuid or google-xxx)
  email        String?
  fullName     String?       @map("full_name")
  avatarUrl    String?       @map("avatar_url")
  provider     String?
  platformRole PlatformRole @default(rep) @map("platform_role")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  @@map("profiles")
}

model Organization {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  members   OrganizationMember[]
  @@map("organizations")
}

model OrganizationMember {
  id        String   @id @default(uuid()) @db.Uuid
  orgId     String   @map("org_id") @db.Uuid
  userId    String   @map("user_id")
  role      OrgRole  @default(member)
  createdAt DateTime @default(now()) @map("created_at")
  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  @@unique([orgId, userId])
  @@index([userId])
  @@index([orgId])
  @@map("organization_members")
}

model RingcentralToken {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id")
  accessToken  String   @map("access_token")
  refreshToken String   @map("refresh_token")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  @@unique([userId])
  @@map("ringcentral_tokens")
}
